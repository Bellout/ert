			Starting EnKF
                        =============


This document should describe how to get started using the EnKF
implementation from StatoilHydro to do history matching. 

Table of contents

 1. Basic startup.
 2. Files you need.
    2.1  Grid file  
    2.2  SCHEDULE file
    2.3  DATA file
      2.3.1  Include statements
      2.3.2  SOLUTION section
      2.3.3  RPTONLY / SKIPREST / RPTSOL
      2.3.4  MINPV/MINPVV
      2.3.5  The parameters to estimate
     (2.3.6  Optional: INCLUDE -> IMPORT)
 3. About the configuration file:
    3.1  About paths in the config file
    3.2  Basic configuration information
    3.3  Parameters to estimate 
    3.4  Observations
    3.4.1  Well rate observations from SCHEDULE
    3.4.2  Block observations (i.e. RFT)
    3.4.3  Observations of other summary variables.
    3.5  Overriding the site-config configuration
 4. Running it ...  




1. Basic startup 
   -------------
   Start with typing 'enkf' on the command line; if you get command
   not found you must go and nag on your enkf-administrator.

   If the enkf application is installed OK you should get an error
   message like this:

     main: usage ./enkf config_file

     ****************************************************************************
     **                                                                        **
     **  A fatal error occured in the EnKF program, and we have to abort.      **
     **  We now *try* to provide a backtrace, which would be very useful       **
     **  when debugging. The process of making a (human readable) backtrace    **
     **  is quite complex, among other things it involves several calls to the **
     **  external program addr2line. We have arrived here because the program  **
     **  state is already quite broken, so the backtrace might be (seriously)  **
     **  broken as well. In particular it is not thread safe:                  **
     **                                                                        **
     ****************************************************************************
     --------------------------------------------------------------------------------
      #00 util_abort(..) in /h/a152128/EnKF/devel/EnKF/libutil/src/util.c:2387
      #01 main      (..) in /h/a152128/EnKF/devel/EnKF/libenkf/src/main.c:55
     --------------------------------------------------------------------------------
     Abort

   That is because the enkf application requires a configuration file
   as the first and only argument. A large part of the remaining part
   of this document is related to this configuration file.


2. Before you can start the EnKF simulation you need some files from
   an ordinary ECLIPSE simulation on the same model. Some of the files
   must be edited a bit before the simulation can start.

   2.1 The EnKF simulation needs a grid file from an existing
       simulation. The EnKF application can use both EGRID and GRID
       files - of both formatted and unformatted type.

       The grid file is (presently) used to map out active/inactive
       cells. This means that the grid file must contain an accurate
       description of the active and inactive cells. If the
       MINPV/MINPVV keywords are used in the datafile the consistency
       between the GRID file and the GRID section in the ECLIPSE can
       be a bit tricky. See details in section 2.3.1.

   2.2 The SCHEDULE file is used to force the ECLIPSE simulation in
       the normal way, in addition the EnKF application parses the
       SCHEDULE file and reads historical rates from the WCONHIST
       keywords. One time-step for EnKF application corresponds to one
       DATES keyword in the schedule file, this means that the longer
       DATES periods in the SCHEDULE file, the longer time the EnKF
       simulation will take.

       The SCHEDULE file can be used nearly unchanged, but please
       ensure the following:

         o The file should end with 'END'.
         o It is only allowed with one schedule file, nested SCHEDULE
           files will not be parsed correctly.
         o The files often seem to have a really confused opinion of
           which end-of line convention to use. The program eol-fix.x
           does a quite decent job.

   2.3 There are several alterations which must be done to the
       datafile prior to starting the EnKF application.

       2.3.1 The EnKF simulations will be run 'all-over-place'
             filesystem wise, it is therefor *STRONGLY* advised to
             replace all relative paths in include statements with
             absolute paths.

       2.3.2 The (ECLIPSE)-init of the simulations are different for
             the first time step and the following timesteps, this
             implies that the SOLUTION section in the datafile must
             be updated between the first and the second timestep:

               First timestep: The solution section must have the
               'EQUIL' keyword for ECLIPSE to calculate the initial
               fluid distribution (alternatively they can be imported
               from an external application).

               Remaining timesteps: The solution section must contain
               a 'RESTART ' keyword.

             The way we have solved this with the EnKF application is
             that you should replace the existing initialization code
             (i.e. typically an EQUIL keyword) with the string
             <INIT>. This is then replaced with the correct code by
             EnKF automagically(?!) (but - see comment about INIT_FILE
             in section 3.3).

       2.3.3 There are a couple of keywords which MUST be present in
             the DATAFILE for EnKF to operate correctly.

             RPTONLY: This keyword must be present in the SUMMARY
             section of the datafile. This keyword ensures that
             ECLIPSE writes date to the summary file only at the
             report steps; for EnKF it essential to have temporal
             consistency between summary data and restart data, and
             currently this is enforced with the use of this keyword. 

             SKIPREST: This keyword must be in the SCHEDULE section,
             typically just before the actual SCHEDULE content. If
             this keyword is not present restarts will not work
             correctly. 

             RPTSOL: This keyword controls the output of restart
             files/reports (I think there are actually several nearly
             identical keywords here). This works at least:

             RPTSOL
                 RESTART=2 /

     
       2.3.4 The MINPV/MINPVV keywords. (This section only applies if
             you are attempting to estimate the PORO and/or the MULTPV
             keywords - however that is a quite common thing to do.)
             When you specify a value for MINPV, all cells with pore
             volume below this limit will become inactive, when the
             ensemble members have different values for PORO/MULTPV
             the spatial distribution of active/inactive cells will
             vary (slightly) among the members, and then ** ALL HELL
             IS LOOSE **.

	     The following approach to MINPV/MINPVV is suggested:

	     1. Run the base case model with the MINPV/MINPVV keywords
                present and produce an EGRID file by using the
                GRIDFILE keyword. (If you already have an EGRID file
                you can use that one).

	     2. Remove MINPV/MINPVV from the datafile.

             3. Run the following command:
 
                  bash% kw_extract.x <EGRID_FILE> <OUTPUT_FILE> COORD ZCORN ACTNUM 
                         
                This will extract the ECLIPSE variables COORD, ZCORN
                and ACTNUM from the EGRID_FILE and write them to the
                OUTPUT_FILE. 

             4. In the grid section of the data file, replace
	        include statements including grdecl/zcorn/actnum with
	        the following statement:
 
                IMPORT 
                   '<OUTPUT_FILE>' /

                Where OUTPUT_FILE is the file name you gave on the
                command line. An extra advantage with this is that
                reading grid information into ECLIPSE is considerably
                faster (assuming your EGRID file was binary).


       2.3.5 The parameters to estimate. In some way you have to get
             the parameters to estimate into ECLIPSE. There are many
             ways to do this, but the most common is that you insert a 

             INCLUDE
                 '<FILENAME>' / 
  
             statement into the datafile. The FILENAME should
             typically correspond to the filename given in the
             configuration file, see section 3.3.

             Observe that when estimating full fields, like PERMX and
             PORO, you should use IMPORT instead of include. The
             reason for this is that IMPORT allows the use of binary
             files, which does speed up the reading and writing of
             files considerably.

     

3.  The configuration file. Section 3.1 describes how the EnKF
    application interprets pathnames within the configuration file. 

    For running EnKF we bascially have to enter three different types
    of configuration information: (1): Basic information of where
    various files are found, ensemble size, ,,,, (2): Which parameters
    we want to update in the analysis and (3) which observations to
    use. These three things are described in sections 3.2 - 3.4.


  3.1 The configuration file is first and only input argument given
      when starting the EnKF application. One of the first things the
      EnKF application does is to decompose the config file argument
      into a leading path part, and the actual filename. It then does
      a chdir() into the path, that means that all paths and files
      refered to in the configuration are interpreted relative to the
      path given on the command line (did that make sense?).


  3.2 The configuration file must contain (at least) the following
      parameters:

      SIZE: This is just the size of the ensemble, i.e. the number of
        members in the ensemble.

      GRID: This is the name of an existing GRID/EGRID file for the
        current case.

      START_TIME: This is the starting time of the simulation, this
        string should just be taken verbatim from the START keyword in
        the ECLIPSE data file, i.e. "1 JAN 2000" (without the
        "). Unfortunately this is different from the date format used in
        the rest of the EnKF application.

      SCHEDULE_FILE: This is the name of the SCHEDULE file, this will be
        used to control the ECLIPSE simulations, in addition historical
        rates of oil, water and gas, will be taken from the schedule
        file. 

      DATA_FILE: This is the name of ECLIPSE DATA file used to control
        the simulations. The data file should be edited according to the
        description in section 2.3.

      ENS_PATH: This is the root path for storage of the ensemble.

      INIT_FILE: This should point to a file containing initialization
        code for the ECLIPSE run. If you are using the EQUIL keyword to
        estimate initial WOC/GOC the EnKF application will automagically
        take care of this.

      The variable RUNPATH and ECLBASE are examples of format variables;
      they should contain an intger format string (i.e. %d) which is
      replaced with ensemble number at run time. This is currently not
      checked for; the EnKF application will run happily with incorrect
      integer formats, but the results will be rubbish.

      RUNPATH: This should be directory pointing to where you want to
        perform the ECLIPSE simulations. The value should contain an
        integer format spesification, which will be replaced with the
        ensemble number at run-time.

      ECLBASE: This is the ECLIPSE basename used for the
        simulations. It is a format variable which should contain a %d
        specifier.


  3.3 The next thing we must specify in the configuration file is the
      parameters to estimate. The standard structure of this is as
      follows (but there are MANY exceptions):

      <PARAMETER-TYPE> <UNIQUE-ID> <TARGET_FILE>  <CONFIG_FILE>

      The PARAMETER-TYPE string is discussed below. The UNIQUE-ID is
      a string (with no spaces in it); this is the keyword used
      internally by the EnKF application to identify the various
      parameters, and also what is used as label when exporting
      results++

      The TARGET_FILE is the name of a (typically ECLIPSE input) file
      generated for this parameter. This should  then typically be
      inluded in the simulation with an INCLUDE <TARGET_FILE> /
      statement in the DATAFILE.

      The CONFIG_FILE will typically contain additional configuration
      information for the parameter, e.g. initial distribution+++

      
      The following parameter types are (currently) supported (not all
      fully implemented):

	MULTZ, MULTFLT, EQUIL, FIELD , WELL, PGBOX, GEN_KW, RELPERM,
	HAVANA_FAULT, SUMMARY 
      
      Here follows a brief description of each parameter type, and how
      the configuration information should be entered:
  
      MULTZ: This parameter is intended for estimating MULTZ barriers
        between layers. In the main configuration file it follows the
        standard structure described above. The spesific configuration
        file for the MULTZ parameter has the following structure:

        k  <i1  i2   j1   j2>  <PRIOR-DISTRIBUTION>
        k                      <PRIOR-DISTRIBUTION>
        .....
        .....

  
        Each line corresponds to one MULTZ parameter. The first value,
        k, is the layer we are etsimating on. (A value of k = 3, means
        we are estimating the vertical transmissibility multiplier
        between layer 'k' and layer 'k + 1'. The arguments i1 i2 j1 j2
        are the horizontal extent of the layer, if omitted the MULTZ
        parameter is applied to the whole layer. The prior
        distribution is specified with a name and the optional
        parameters to this distribution (see section 3.3.1 for various
        prior distributions).
  

     MULTFLT: This parameter is for estimating MULTFLT multipliers. It
        is very similar in structure to the MULTZ parameter. The
        specific MULTFLT configuration file look like this:
  
        <FAULT-NAME1>    <PRIOR-DISTRIBUTION>
        <FAULT-NAME2>    <PRIOR-DISTRIBUTION>
        ..... 
        

     EQUIL: This parameter is for estimating initial 
     
       
  3.4 The observations are specified in a (several) file(s) of their
      own. From the main configuration this file is specified with the
      keyword OBS_CONFIG - which should then point to another file
      containing information about the observations.

      Currently the system supports three different types of
      observations:

      WELL: This is observations of well rates, the actual
        observations are taken directly from the SCHEDULE file.

      BLOCK: This is observations of cell/block properties. The
        observations can be of arbitrary ECLIPSE fields like PRESSURE
        (typically for an RFT), PORO or ... The actual values must be
        entered by the user in a seperate configuration file.

      SUMMARY: This is arbitrary data which can be read out from the
        summary file. I.e. well rates, region properties, ... As with
        BLOCK observations the actual values must be specified by the
        user in a separate file.





    













   
